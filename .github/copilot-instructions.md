# SonicRide - Copilot Instructions

## Project Overview
SonicRide is a motorcycle GPS track analysis and Spotify playlist generator that transforms GPX files into personalized music experiences. The system processes GPS data through a **three-stage pipeline**: GPX timestamp generation → ride metrics analysis → AI-powered playlist creation.

## Core Architecture

### Data Flow Pipeline
1. **Raw GPX** (`gpx/trip*.gpx`) → **Timestamped GPX** (`gpx_timestamp_generator.py`)
2. **Timestamped GPX** → **Metrics CSV** (`ride_metrics.py`) 
3. **Metrics CSV** → **Spotify Playlist** (`sonicride.py`)

### Key Files & Responsibilities
- `gpx_timestamp_generator.py` - OSRM map-matching for realistic travel times
- `ride_metrics.py` - Physics-based motorcycle lean angle calculation (25-40° street caps)
- `sonicride.py` - Spotify integration with mood-based music selection
- `analyze_*.py` - Debugging utilities for GPX and metrics validation

## Critical Patterns

### GPX Processing
- All GPX files live in `gpx/` folder with auto-resolution (`resolve_gpx_path()`)
- Timestamp generation uses **chunked OSRM requests** (max 100 points) to avoid URL limits
- Speed limits fetched via **Overpass API** in 50-point batches to prevent timeouts
- Elevation data from `open-elevation.com` API with 100-point batching

### Motorcycle Physics Engine
The lean angle calculation in `ride_metrics.py` applies **realistic street riding caps**:
```python
# Physics-based calculation with street riding limits
if turn_radius_m < 30:      # City corners
    max_realistic = 25.0
elif turn_radius_m < 100:   # Normal streets  
    max_realistic = 32.0
elif turn_radius_m < 300:   # Country roads
    max_realistic = 38.0
else:                       # Highway sweepers
    max_realistic = 40.0
```

### Spotify Integration
- Uses **dual authentication**: `SpotifyClientCredentials` for search + `SpotifyOAuth` for playlist creation
- **Smart search strategy**: Uses multiple genre queries with fallback to avoid rate limits
- **Duration matching**: Selects tracks to match ride duration using `track['duration_ms']`
- **Mood mapping**: Speed + lean angle → 6 mood categories → genre/energy/tempo parameters

### CLI Conventions
All scripts follow consistent patterns:
- `--debug` flag for verbose OSRM/API logging
- Input files auto-resolve to `gpx/` folder
- Output files default to `gpx/` with `_timestamped` or `_metrics` suffixes
- Environment variables in `.env` for Spotify credentials

## Development Workflows

### Complete Processing Chain
```bash
# 1. Add timestamps to raw GPX
python gpx_timestamp_generator.py trip1.gpx --debug

# 2. Generate ride metrics with physics
python ride_metrics.py -i gpx/trip1_timestamped.gpx -o trip1_metrics.csv

# 3. Create Spotify playlist
python sonicride.py --metrics trip1_metrics.csv --debug
```

### Debugging & Validation
```bash
# Analyze raw GPX timing patterns
python analyze_gpx.py gpx/trip1_timestamped.gpx

# Validate ride metrics and cornering analysis  
python analyze_ride.py trip1_metrics.csv
```

## Integration Points

### External APIs
- **OSRM Public Server**: `http://router.project-osrm.org` (fallback to local if available)
- **Overpass API**: OpenStreetMap speed limit queries with timeout handling
- **Spotify Web API**: Requires `SPOTIFY_CLIENT_ID` and `SPOTIFY_CLIENT_SECRET` in `.env`
- **Open Elevation API**: Elevation data fetching with batch processing

### Error Handling Patterns
- **OSRM failures**: Graceful fallback to time-based distribution over 1 hour
- **Rate limiting**: Exponential backoff with configurable retry attempts
- **Large routes**: Automatic chunking with overlap to maintain continuity
- **Missing data**: CSV columns can be `None`; lean angles only calculated for 10-180 km/h speeds

## Data Formats

### Metrics CSV Schema
```csv
time,lat,lon,altitude_m,speed_kmh,lean_angle_deg,turn_radius_m_raw,dt_s,distance_m
```
- `time`: ISO timestamp from OSRM timing
- `lean_angle_deg`: Physics-calculated, street-capped (25-40°)
- `turn_radius_m_raw`: Circumcircle method from GPS triplets
- All values can be `None` for edge cases

### GPX Enhancement
- Original GPX preserved in tracks/routes
- Enhanced with `<time>` elements for every track point
- Elevation data backfilled from API if missing
- Metadata includes "Generated by GPX Timestamp Generator"

## Performance Considerations
- **Batch processing**: All API calls use appropriate batch sizes to prevent timeouts
- **Memory efficient**: Streaming GPX parsing, no full-file loading
- **Rate limit aware**: Built-in backoff for Spotify and mapping APIs
- **Fallback strategies**: Every external dependency has offline alternatives